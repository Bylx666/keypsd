(()=>{var e={603:e=>{e.exports={Parser:class{constructor(e){this.buf=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.i=0,this.decoder=new TextDecoder}u8(){return this.i+=1,this.view.getUint8(this.i-1)}i8(){return this.i+=1,this.view.getInt8(this.i-1)}u16(e){return this.i+=2,this.view.getUint16(this.i-2,e)}i16(e){return this.i+=2,this.view.getInt16(this.i-2,e)}u32(e){return this.i+=4,this.view.getUint32(this.i-4,e)}i32(e){return this.i+=4,this.view.getInt32(this.i-4,e)}f32(e){return this.i+=4,this.view.getFloat32(this.i-4,e)}f64(e){return this.i+=8,this.view.getFloat64(this.i-8,e)}skip(e){this.i+=e}skipTo(e){this.i=e}isEnded(){return this.i>=this.buf.byteLength}read(e){return this.i+=e,this.buf.slice(this.i-e,this.i)}str(e){return this.decoder.decode(this.read(e))}unicode(){let e=this.read(2*this.u32());for(let t=0;t<e.byteLength;t+=2)[e[t],e[t+1]]=[e[t+1],e[t]];return String.fromCodePoint.apply(null,new Uint16Array(e.buffer)).replace(/\u0000/g,"")}},Gener:class{constructor(e=1){this.buf=new Uint8Array(e),this.view=new DataView(this.buf.buffer),this.i=0,this.encoder=new TextEncoder}go(e){for(this.i+=e;this.i>=this.buf.byteLength;){let e=this.buf;this.buf=new Uint8Array(2*e.byteLength),this.view=new DataView(this.buf.buffer),this.buf.set(e,0)}}u8(e){this.go(1),this.view.setUint8(this.i-1,e)}i8(e){this.go(1),this.view.setInt8(this.i-1,e)}u16(e,t){this.go(2),this.view.setUint16(this.i-2,e,t)}i16(e){this.go(2),this.view.setInt16(this.i-2,e)}u32(e){this.go(4),this.view.setUint32(this.i-4,e)}i32(e){this.go(4),this.view.setInt32(this.i-4,e)}f64(e){this.go(8),this.view.setFloat64(this.i-8,e)}write(e){return this.go(e.byteLength),this.buf.set(e,this.i-e.byteLength),e.byteLength}str(e){return this.write(this.encoder.encode(e))}unicode(e){this.u32(e.length);let t=new DataView(new ArrayBuffer(2*e.length));for(let r=0;r<e.length;++r)t.setUint16(2*r,e.charCodeAt(r));this.write(new Uint8Array(t.buffer))}markSize(){let e=this;e.go(4);let t=e.i;return{i:t,end(){let r=e.i-t;return e.view.setUint32(t-4,r),r}}}export(){return this.buf.subarray(0,this.i)}}}},295:e=>{const t={Left:["UntF",0],Top:["UntF",0],Rght:["UntF",0],Btom:["UntF",0]};let r={name:"",cls:"TxLr",ls:{Txt:["TEXT",""],textGriddin:["enum",["textGridding","None"]],Ornt:["enum",["Ornt","Hrzn"]],AntA:["enum",["Annt","antiAliasSharp"]],bounds:["Objc",{name:"",cls:"bounds",ls:t}],boundingBox:["Objc",{name:"",cls:"boundingBox",ls:t}],TextIndex:["long",0],EngineData:["tdta",new Uint8Array(0)]}};const n={TEXT:(e,t)=>e.unicode(t),enum(e,[t,r]){i(e,t),i(e,r)},Objc:o,GlbO:o,UntF:(e,t)=>(e.str("#Pnt"),e.f64(t)),doub:(e,t)=>e.f64(t),long:(e,t)=>e.i32(t),tdta:(e,t)=>e.u32(t.byteLength)|e.write(t)};let i=(e,t)=>e.u32(t.length)|e.str(t);function o(e,{name:t,cls:r,ls:o}){e.unicode(t),i(e,r);let s=Object.keys(o);e.u32(s.length);for(const t of s){let[r,s]=o[t];i(e,t),e.str(r),n[r](e,s)}}o.text=(e,t,n)=>{r.ls.Txt[1]=t,r.ls.EngineData[1]=n,o(e,r)},o.textWrap=e=>o(e,{name:"",cls:"wrap",ls:{}}),e.exports=o},852:(e,t,r)=>{const n=r(395);async function i(e){let t=new Image;return t.src=URL.createObjectURL(new Blob([e])),o(t)}async function o(e){await new Promise(((t,r)=>{if(e.complete)return t();e.onload=()=>t(),e.onerror=()=>r(new Error("错误图片资源"))}));let t=document.createElement("canvas");return t.width=e.naturalWidth,t.height=e.naturalHeight,t.getContext("2d").drawImage(e,0,0),s(t)}function s(e){let{width:t,height:r}=e,i=e.getContext("2d").getImageData(0,0,t,r),o={width:i.width,height:i.height,layers:[{image:i.data}]};return n(o)}e.exports=async function(e){if("string"==typeof e)return async function(e){return await i(await fetch(e).then((e=>e.blob())))}(e);if(e instanceof ArrayBuffer||e instanceof Uint8Array||e instanceof Blob)return i(e);if(e instanceof HTMLImageElement)return o(e);if(e instanceof HTMLCanvasElement)return s(e);throw new TypeError("generFrom不支持该类型. 详见'https://github.com/Bylx666/keypsd/blob/master/readme.md#generFrom'")}},395:(e,t,r)=>{const{Gener:n}=r(603),i=r(656);e.exports=function(e){let t=new n(4095);t.psd=e;let{width:r,height:o}=e;if(!r||!o)throw new TypeError("keypsd.gener需要你的传入的对象有正整数width和height");return t.str("8BPS"),t.u16(1),t.go(6),t.u16(3),t.u32(o),t.u32(r),t.u16(8),t.u16(3),t.u32(0),t.u32(0),i(t),function(e){let{width:t,height:r}=e.psd;e.u16(0),e.go(t*r*4)}(t),t.export()}},734:(e,t,r)=>{const n=r(852),i=r(395);e.exports={gener:i,generFrom:n}},656:(e,t,r)=>{const{encode:n}=r(283),i=r(628),o={normal:"norm",darken:"dark",multiply:"mul ","color-burn":"idiv",lighten:"lite",screen:"scrn","color-dodge":"div ",overlay:"over","soft-light":"sLit","hard-light":"hLit",difference:"diff",exclusion:"smud",hue:"hue ",saturation:"sat ",color:"colr",luminosity:"lum "};function s(e,t,r){e.str("8BIM"),e.str(t);let n=e.markSize();r(),n.end()}function a(e,t){let{image:r,blendMode:n,opacity:a,visible:l,name:u}=t;if(t.width=t.width||e.psd.width,t.height=t.height||e.psd.height,[t.left,t.top]=[t.left||0,t.top||0],e.u32(t.top),e.u32(t.left),e.u32(t.top+t.height),e.u32(t.left+t.width),r&&r.byteLength){if(r.byteLength!==t.width*t.height*4)throw new Error(`'${u}'图层图像大小错误`);e.u16(4),t.channelMetaIndex=e.i,e.go(24)}else e.u16(0);e.str("8BIM"),e.str(o[n]||"norm"),e.u8("number"==typeof a?a:255),e.u8(0),e.u8(!1===l?10:8),e.u8(0),function(e,{name:t,folder:r,text:n,left:o,top:a}){let l=e.markSize();e.u32(0);let u=e.markSize();for(let t=0;t<10;++t)e.u32(65535);u.end(),e.u8(3),e.str("art"),t&&s(e,"luni",(()=>e.unicode(t))),r&&s(e,"lsct",(()=>e.u32("close"===r?3:1))),n&&s(e,"TySh",(()=>i(e,n.chars,o,a))),l.end()}(e,t)}function l(e,{image:t,channelMetaIndex:r,height:i,width:o}){if(!t||!t.byteLength)return;let s=t.byteLength/4;for(let a=0;a<4;++a){let l=new Uint8Array(s),u=(a+3)%4;for(let e=0;e<s;++e)l[e]=t[4*e+u];e.u16(1);let h=e.i;e.go(2*i);let f=2*i+2;for(let t=0;t<i;++t){let r=n(l.subarray(t*o,(t+1)*o));e.view.setUint16(h+2*t,r.byteLength),f+=r.byteLength,e.write(r)}e.view.setInt16(r+6*a,a-1),e.view.setUint32(r+6*a+2,f)}}e.exports=e=>{let t=e.markSize(),r=e.markSize(),n=e.psd.layers;e.i16(-n.length);for(let t of n)a(e,t);for(let t of n)l(e,t);r.end(),function(e){let t=e.markSize();e.u16(0),e.go(8),e.u16(100),e.u8(128),e.go(3),t.end()}(e),t.end()}},628:(e,t,r)=>{const{Gener:n}=r(603),{text:i,textWrap:o}=r(295),s=[{Name:"MicrosoftJhengHeiUIRegular",Script:2,FontType:1,Synthetic:3}],a=[{Name:"正常 RGB",DefaultStyleSheet:0,Properties:{}}];let l={EngineDict:{Editor:{Text:""},ParagraphRun:{DefaultRunData:{ParagraphSheet:{DefaultStyleSheet:0,Properties:{}},Adjustments:{Axis:[1,0,1],XY:[0,0]}},RunArray:[],RunLengthArray:[],IsJoinable:1},StyleRun:{DefaultRunData:{StyleSheet:{StyleSheetData:{}}},RunArray:[],RunLengthArray:[],IsJoinable:0},GridInfo:{GridIsOn:!1},AntiAlias:4,UseFractionalGlyphWidths:!0,Rendered:{Version:1,Shapes:{WritingDirection:0,Children:[{ShapeType:0,Procession:0,Lines:{WritingDirection:0,Children:[]},Cookie:{Photoshop:{ShapeType:0,PointBase:[0,0],Base:{ShapeType:0,TransformPoint0:[1,0],TransformPoint1:[0,1],TransformPoint2:[0,0]}}}}]}}},ResourceDict:{ParagraphSheetSet:a,StyleSheetSet:a,FontSet:s},DocumentResources:{ParagraphSheetSet:a,StyleSheetSet:a,FontSet:s}};const u=["Axis","XY","Zone","WordSpacing","FirstLineIndent","GlyphSpacing","StartIndent","EndIndent","SpaceBefore","SpaceAfter","LetterSpacing","Values","GridSize","GridLeading","PointBase","BoxBounds","TransformPoint0","TransformPoint1","TransformPoint2","FontSize","Leading","HorizontalScale","VerticalScale","BaselineShift","Tsume","OutlineWidth","AutoLeading"];e.exports=(e,t,r,s)=>{let h=function(e){let t="",r=0,n=[0],i=l.EngineDict.StyleRun,o=l.EngineDict.ParagraphRun;return e.push({char:"\n"}),i.RunArray=e.map((({char:e,size:i,color:o,underline:s,bold:a,italic:l})=>(r+=1,"\n"===e&&(e="\r",n.push(r-n[n.length-1])),t+=e,{StyleSheet:{StyleSheetData:{Font:0,FontSize:i||16,FauxBold:!!a,FauxItalic:!!l,Underline:!!s,AutoLeading:!0,Tracking:0,AutoKerning:!0,FillColor:{Type:1,Values:o=[1,...[].map.call(o||[0,0,0],(e=>e/255))].slice(0,4)}}}}))),n.shift(),o.RunArray=new Array(n.length).fill({ParagraphSheet:a[0],Adjustments:{Axis:[1,0,1],XY:[0,0]}}),i.RunLengthArray=new Array(r).fill(1),o.RunLengthArray=n,i.IsJoinable=r,l.EngineDict.Editor.Text=t,t}(t);s+=t[0]&&t[0].size?t[0].size:16,e.u16(1),[1,0,0,1,r,s].forEach((t=>e.f64(t))),e.u16(50),e.u32(16),i(e,h,function(e){let t=new n(1024);return function e(r,n){function i(e){switch(e){case 40:case 41:case 92:t.u8(92)}t.u8(e)}switch(t.str(" "),typeof r){case"string":t.str("("),t.u16(65279);for(let e=0;e<r.length;++e){var o=r.charCodeAt(e);i(o>>>8&255),i(255&o)}t.str(")");break;case"number":t.str(n&&-1!==u.indexOf(n)?r.toFixed(5):r.toString());break;case"boolean":t.str(r);break;case"object":if(Array.isArray(r)){if(t.str("["),r.some((e=>"number"!=typeof e)))for(let t of r)e(t,n);else if("RunLengthArray"===n)for(let e of r)t.str(" "+e.toString());else for(let e of r)t.str(" "+e.toFixed(5));t.str("]")}else{t.str("<<");for(let n of Object.keys(r))t.str(" /"+n),e(r[n],n);t.str(">>")}}}(e),t.export()}(l)),e.u16(1),e.u32(16),o(e),e.go(32)}},138:(e,t,r)=>{const{gener:n,generFrom:i}=r(734),{parse:o,parseFrom:s}=r(435);e.exports={parse:o,parseFrom:s,gener:n,generFrom:i}},853:e=>{const t={TEXT:e=>e.unicode(),enum:e=>({name:r(e),value:r(e)}),Objc:n,GlbO:n,UntF:e=>(e.skip(4),e.f64()),doub:e=>e.f64(),long:e=>e.i32(),tdta:e=>e.read(e.u32())};let r=e=>e.str(e.u32()||4);function n(e){let n=e.unicode(),i=r(e),o=e.u32(),s={name:n,cls:i};for(let n=0;n<o;++n){let n=r(e).trim(),i=e.str(4);s[n]=t[i](e)}return s}e.exports=n},915:(e,t,r)=>{const n=r(173);e.exports=async e=>{if("string"==typeof e)return n(await(await fetch(e)).arrayBuffer());if(e instanceof ArrayBuffer||e instanceof Uint8Array)return n(e);if(e instanceof Blob)return n(await e.arrayBuffer());throw new TypeError("parseFrom不支持该类型. 详见'https://github.com/Bylx666/keypsd/blob/master/readme.md#parseFrom'")}},800:e=>{const t={3:"RGB"};let r=(e,t)=>{if(!e)throw new Error(t)};e.exports=e=>{r("8BPS"===e.str(4),"无效PSD文件"),e.skip(8);let n=e.u16(),i=e.u32(),o=e.u32(),s=e.u16();r(8===s,"暂时只支持8位深度图像");let a=t[e.u16()];return r(a,"暂时只支持RGB色彩模式"),{channels:n,height:i,width:o,depth:s,mode:a}}},435:(e,t,r)=>{const n=r(173),i=r(915);e.exports={parse:n,parseFrom:i}},380:(e,t,r)=>{const n=r(534),i=r(853),o=r(159),s={norm:"normal",dark:"darken",mul:"multiply",idiv:"color-burn",lite:"lighten",scrn:"screen",div:"color-dodge",over:"overlay",sLit:"soft-light",hLit:"hard-light",diff:"difference",smud:"exclusion",hue:"hue",sat:"saturation",colr:"color",lum:"luminosity"};function a(e){const t={luni:()=>({name:e.unicode()}),lyid:()=>(e.skip(4),{id:e.u32()}),lsct:()=>({folder:3===e.u32()?"close":"open"}),TySh(){e.skip(2);let t=new Float64Array(6);for(let r=0;r<6;++r)t[r]=e.f64();e.skip(6);let r=i(e),n=o(r.EngineData);return e.skip(6),i(e),{text:{transform:t,raw:r,chars:n,text:n.text}}}};e.skip(4);let r=e.str(4),n=e.u32(),s=e.i+n,a=t[r]?t[r]():null;return e.skipTo(s),a}function l(e){let t=e.i32(),r=e.i32(),n=e.i32()-t,i=e.i32()-r,o=e.u16(),l=new Array(o);for(let t=0;t<o;++t)l[t]={id:e.i16(),dataLen:e.u32()-2};e.skip(4);let u=s[e.str(4).trim()];u||(u="normal");let h=e.u8();e.skip(1);let f=!(2&e.u8());e.skip(1);let c=e.u32(),d=e.i+c;e.skip(e.u32()),e.skip(e.u32());let g={top:t,left:r,width:i,height:n,name:e.str((e.u8()+1+3&-4)-1),visible:f,blendMode:u,opacity:h,channels:l};for(;e.i<d;)Object.assign(g,a(e));return e.skipTo(d),g}e.exports=e=>{let t=e.u32(),r=e.i+t;e.u32();let i=Math.abs(e.i16()),o=new Array(i);for(let t=0;t<i;++t)o[t]=l(e);return n(e,o),e.skipTo(r),o}},534:(e,t,r)=>{const{decode:n}=r(283);function i(e,t){let{width:r,height:i,channels:o}=t,s=r*i,a=new Uint8Array(4*s);for(let r of o){let o=e.u16();if(!r.dataLen||r.id<-1||o>1)continue;let u=e.read(r.dataLen);switch(1===o&&(u=n(u.subarray(2*i),s)),u.byteLength!==s&&console.warn(`'${t.name}'图层的'${r.id}'通道数据损坏`),r.id){case-1:var l=3;break;case 0:case 1:case 2:l=r.id;break;default:continue}for(let e=0;e<s;++e)a[4*e+l]=u[e]}return a}e.exports=(e,t)=>{for(let r of t)r.image=i(e,r)}},173:(e,t,r)=>{const{Parser:n}=r(603),i=r(800),o=r(380);e.exports=e=>{if(e instanceof ArrayBuffer&&(e=new Uint8Array(e)),!e instanceof Uint8Array)throw new TypeError("keypsd.parse只允许`Uint8Array`和`ArrayBuffer`");let t=new n(e),r=i(t);return t.skip(t.u32()),t.skip(t.u32()),r.layers=o(t),r}},159:e=>{e.exports=e=>{e=function(e){function t(e){return 32===e||10===e||13===e||9===e}function r(e){return e>=48&&e<=57||46===e||45===e}var n=0;function i(){for(;n<e.length&&t(e[n]);)n++}function o(){var t=e[n];return n++,92===t&&(t=e[n],n++),t}function s(){var t="";if(41===e[n])return n++,t;if(254!==e[n]||255!==e[n+1])throw new Error("Invalid utf-16 BOM");for(n+=2;n<e.length&&41!==e[n];){var r=o()<<8|o();t+=String.fromCharCode(r)}return n++,t}var a=null,l=[];function u(e){l.length?(h(e),l.push(e)):(l.push(e),a=e)}function h(e){if(!l.length)throw new Error("Invalid data");var t=l[l.length-1];if("string"==typeof t)l[l.length-2][t]=e,c();else{if(!Array.isArray(t))throw new Error("Invalid data");t.push(e)}}function f(e){l.length||u({});var t=l[l.length-1];if(t&&"string"==typeof t)h("nil"===e?null:"/".concat(e));else{if(!t||"object"!=typeof t)throw new Error("Invalid data");l.push(e)}}function c(){if(!l.length)throw new Error("Invalid data");l.pop()}for(i();n<e.length;){var d=n,g=e[d];if(60===g&&60===e[d+1])n+=2,u({});else if(62===g&&62===e[d+1])n+=2,c();else if(47===g){for(var p=n+=1;n<e.length&&!t(e[n]);)n++;for(var y="",w=p;w<n;w++)y+=String.fromCharCode(e[w]);f(y)}else if(40===g)n+=1,h(s());else if(91===g)n+=1,u([]);else if(93===g)n+=1,c();else if(110===g&&117===e[d+1]&&108===e[d+2]&&108===e[d+3])n+=4,h(null);else if(116===g&&114===e[d+1]&&117===e[d+2]&&101===e[d+3])n+=4,h(!0);else if(102===g&&97===e[d+1]&&108===e[d+2]&&115===e[d+3]&&101===e[d+4])n+=5,h(!1);else if(r(g)){for(var m="";n<e.length&&r(e[n]);)m+=String.fromCharCode(e[n]),n++;h(parseFloat(m))}else n+=1,console.log("Invalid token ".concat(String.fromCharCode(g)," at ").concat(n));i()}return a}(e);let{Editor:{Text:t},StyleRun:{RunArray:r,RunLengthArray:n}}=e.EngineDict;t=t.replace(/\r/g,"\n");let i=e.ResourceDict.FontSet.map((e=>e.Name)),o=Array.from(t).map(((e,t)=>{for(var o=0;o<r.length&&!((t-=n[o])<0);)o+=1;let s=r[o].StyleSheet.StyleSheetData,a=s.FillColor.Values.map((e=>0|255*e));return a.push(a.shift()),{char:e,color:new Uint8Array(a),font:i[s.Font],size:s.FontSize,underline:!!s.Underline,bold:!!s.FauxBold,italic:!!s.FauxItalic}}));return o.text=t,o}},283:(e,t,r)=>{const{Gener:n,Parser:i}=r(603);e.exports={decode:function(e,t){let r=new i(e),o=new n(t);for(;!r.isEnded();){let e=r.i8();if(e>=0)o.write(r.read(1+e));else if(-128!==e){let t=r.u8();o.write(new Uint8Array(1-e).fill(t))}}return o.export()},encode:e=>function(e,t){for(;!e.isEnded();){let r=e.u8();if(e.isEnded()){t.u8(0),t.u8(r);break}let n=e.u8(),i=-1;if(r===n){for(;!e.isEnded()&&(n=e.u8())===r&&i>-127;)i--;if(t.i8(i),t.u8(r),e.isEnded()&&n===r)break}else{let o=t.i;for(t.go(1),t.u8(r);!e.isEnded()&&r!==n&&i<127;)i++,t.u8(n),[r,n]=[n,e.u8()];if(e.isEnded()&&n!==r){t.u8(n),t.view.setInt8(o,i+2);break}t.i--,e.i--,t.view.setInt8(o,i)}e.i--}return t.export()}(new i(e),new n(e.byteLength)),encode0s:function(e){let t=new n(0|e/64+4),r=0|e/128,i=e%128;for(;r--;)t.i8(-127),t.u8(0);return i&&(t.i8(i-1),t.go(i)),t.export()}}}},t={},r=function r(n){var i=t[n];if(void 0!==i)return i.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,r),o.exports}(138);keypsd=r})();