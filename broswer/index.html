<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>PSD解析和生成</title>
    <script src="./keypsd.js"></script>
    <style>
        #layer-list {
            display: flex;
            flex-wrap: wrap;
        }
        #layer-list > div {
            margin: 10px;
            border-right: 1px #aaa solid;
        }
        #layer-list > div > canvas {
            position: absolute;
            left: 0; top: 0;
            width: 500px;
            height: 500px;
            object-fit: contain;
            image-rendering: crisp-edges;
        }
        #layer-list > div > p {
            margin: 0;
        }
    </style>
</head>
<body>
    <h2>解析PSD</h2>
    <input type="file" name="input-file" id="file" accept=".psd">
    <div id="layer-list"></div>
    <script>
        // 绑定上传事件
        let $file = document.getElementById("file");
        let $list = document.getElementById("layer-list");
        $file.onchange = async ()=> {
            let buf = await $file.files[0].arrayBuffer();
            $list.textContent = "";
            // 使用keypsd.parse
            let psd = keypsd.parse(buf);
            console.log(psd);

            // 读取layers并显示在layer-list元素
            for (let layer of psd.layers) {
                // 创建元素
                let $div = document.createElement("div");
                $list.append($div);
                // 显示图层名
                let $p = document.createElement("p");
                $p.textContent = layer.name;
                $div.append($p);
                
                if (!layer.width || !layer.height) continue;

                // 读取图层图像
                let $cv = document.createElement("canvas");
                $div.append($cv);
                [ $cv.width, $cv.height ] = [psd.width, psd.height];
                let cx = $cv.getContext("2d");

                if (layer.text) {
                    // 绘制文本
                    let transform = layer.text.transform;
                    let l = 0, t = 0;

                    for (let { 
                        char, font, size, color, bold, italic
                    } of layer.text.chars) {
                        // 处理换行
                        if (char === "\n") {
                            l = 0;
                            t += size * 1.5;
                            continue;
                        }
                        cx.font = (italic? "italic ": "") + (bold? "bold ": "")
                            +`${size}px ${font}`;
                        cx.fillStyle = `rgba(${color[0]} ${color[1]} ${color[2]})`;
                        cx.setTransform(...transform);
                        cx.fillText(char, l, t);
                        console.log(char, l, t, transform);
                        l += cx.measureText(char).width;
                    }
                }else {
                    // 写入图像数据
                    let data = cx.createImageData(layer.width, layer.height);
                    data.data.set(layer.image);
                    cx.putImageData(data, layer.left, layer.top);
                }
            }
        }
    </script>
</body>
</html>